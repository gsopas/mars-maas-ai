<!-- index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mars Weather (Curiosity / MAAS)</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* optional light styles for the AI card; remove if you already style cards */
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-top: 12px; }
    .row { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
    .tag { font-size: 0.85rem; padding: 2px 6px; border-radius: 6px; background: #eee; }
    .loading { opacity: 0.7; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; margin: 12px 0; }
    input[type="url"], input[type="number"] { padding: 6px 8px; min-width: 280px; }
  </style>
</head>
<body>
  <main>
    <h1>Mars Weather</h1>
    <p class="subtitle">Curiosity/REMS via MAAS.</p>

    <p class="subtitle" id="backendHint">
      Paste: <code id="backendUrl">https://mars-maas-ai.onrender.com</code>
      <button class="copy-btn" id="copyBackend" aria-label="Copy backend URL" title="Copy">Copy</button>
      <span id="copyMsg" class="copy-msg" role="status" aria-live="polite"></span>
    </p>

    <div class="controls">
      <label for="backend" class="visually-hidden">Backend</label>
      <input id="backend" aria-label="Backend base URL" placeholder="https://mars-maas-ai-backend.onrender.com" />
      <input id="sol" type="number" min="0" placeholder="Sol (0 = latest)" />
      <button id="go">Fetch</button>
      <button id="btnAi" title="Generate AI summary of this Sol">AI summary</button>
    </div>

    <!-- Output: raw JSON -->
    <pre id="out">Set backend URL and click Fetch…</pre>

    <!-- AI summary box -->
    <section id="aiBox" class="card" aria-live="polite">
      <div class="row">
        <strong>AI summary</strong>
        <span id="aiMode" class="tag"></span>
      </div>
      <p id="aiText">No summary yet.</p>
    </section>
  </main>

  <script>
  (function () {
    // ---------- Copy-to-clipboard ----------
    const btnCopy = document.getElementById('copyBackend');
    const urlEl = document.getElementById('backendUrl');
    const copyMsg = document.getElementById('copyMsg');
    btnCopy.addEventListener('click', async () => {
      const text = (urlEl.textContent || '').trim().replace(/\.$/, '');
      try {
        await navigator.clipboard.writeText(text);
        copyMsg.textContent = 'Copied';
      } catch {
        const ta = document.createElement('textarea');
        ta.value = text; document.body.appendChild(ta); ta.select();
        document.execCommand('copy'); document.body.removeChild(ta);
        copyMsg.textContent = 'Copied';
      }
      setTimeout(() => { copyMsg.textContent = ''; }, 1200);
    });

    // ---------- Elements ----------
    const backendInput = document.getElementById('backend');
    const solInput = document.getElementById('sol');
    const go = document.getElementById('go');
    const out = document.getElementById('out');

    // AI elems
    const btnAi = document.getElementById('btnAi');
    const aiText = document.getElementById('aiText');
    const aiMode = document.getElementById('aiMode');

    // ---------- Helpers ----------
    // Pre-fill from localStorage, otherwise from the "Paste:" hint
    backendInput.value = (localStorage.getItem('BACKEND_URL') || '').trim();
    if (!backendInput.value) {
      backendInput.value = (document.getElementById('backendUrl')?.textContent || '').trim();
    }

    function getBaseUrl() {
      const base = (backendInput.value || '').trim().replace(/\.$/, '');
      return base.endsWith('/') ? base.slice(0, -1) : base;
    }
    function getSol() {
      const v = Number(solInput.value);
      return Number.isFinite(v) && v >= 0 ? v : 0;
    }
    function rememberBase(url) {
      if (url && url.startsWith('http')) {
        localStorage.setItem('BACKEND_URL', url);
      }
    }
    async function fetchJson(url, opts = {}, timeoutMs = 20000) {
      const ctrl = new AbortController();
      const id = setTimeout(() => ctrl.abort(), timeoutMs);
      try {
        const r = await fetch(url, { ...opts, signal: ctrl.signal });
        if (!r.ok) {
          let msg = `HTTP ${r.status}`;
          try {
            const j = await r.json();
            if (j && j.detail) msg += ` — ${j.detail}`;
          } catch {}
          throw new Error(msg);
        }
        return await r.json();
      } finally {
        clearTimeout(id);
      }
    }

    // ---------- Fetch handler (normalised /weather/*) ----------
    go.addEventListener('click', async () => {
      const base = getBaseUrl();
      if (!base) { out.textContent = 'Enter your backend URL above.'; return; }
      rememberBase(base);

      const sol = getSol();
      const path = sol ? `/weather/${encodeURIComponent(sol)}` : '/weather/latest';
      const url = base + path;

      out.textContent = 'Loading…';
      try {
        const data = await fetchJson(url);
        out.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        out.textContent = 'Error: ' + e.message + '\nURL: ' + url;
      }
    });

    // ---------- AI summary handler (/ai/brief/*) ----------
    btnAi.addEventListener('click', async () => {
      const base = getBaseUrl();
      if (!base) { aiText.textContent = 'Enter your backend URL above.'; return; }
      rememberBase(base);

      const sol = getSol();
      const path = sol === 0 ? '/ai/brief/latest' : `/ai/brief/${encodeURIComponent(sol)}`;
      const url = base + path;

      aiMode.textContent = '';
      aiText.textContent = 'Generating summary…';
      btnAi.disabled = true;
      aiText.classList.add('loading');

      try {
        const data = await fetchJson(url);
        aiMode.textContent = data.mode || '';
        aiText.textContent = data.text || 'No text returned.';
      } catch (e) {
        aiMode.textContent = '';
        aiText.textContent = 'Error: ' + e.message + '\nURL: ' + url;
      } finally {
        btnAi.disabled = false;
        aiText.classList.remove('loading');
      }
    });
  })();
  </script>
</body>
</html>
